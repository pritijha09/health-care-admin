import * as tslib_1 from "tslib";
// Imports
import { Component, Input, Output, ViewChild, EventEmitter, NgZone, forwardRef, QueryList, AfterViewInit, ContentChildren, SimpleChanges, OnChanges, } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { CKButtonDirective } from './ckbutton.directive';
import { CKGroupDirective } from './ckgroup.directive';
/**
 * CKEditor component
 * Usage :
 *  <ckeditor [(ngModel)]="data" [config]="{...}" debounce="500"></ckeditor>
 */
import * as Éµngcc0 from '@angular/core';

var _c0 = ["host"];
var CKEditorComponent = /** @class */ (function () {
    /**
     * Constructor
     */
    function CKEditorComponent(zone) {
        this.zone = zone;
        this.change = new EventEmitter();
        this.editorChange = new EventEmitter();
        this.ready = new EventEmitter();
        this.blur = new EventEmitter();
        this.focus = new EventEmitter();
        this.contentDom = new EventEmitter();
        this.fileUploadRequest = new EventEmitter();
        this.fileUploadResponse = new EventEmitter();
        this.paste = new EventEmitter();
        this.drop = new EventEmitter();
        this._value = '';
    }
    CKEditorComponent_1 = CKEditorComponent;
    Object.defineProperty(CKEditorComponent.prototype, "value", {
        get: function () {
            return this._value;
        },
        set: function (v) {
            if (v !== this._value) {
                this._value = v;
                this.onChange(v);
            }
        },
        enumerable: true,
        configurable: true
    });
    CKEditorComponent.prototype.ngOnChanges = function (changes) {
        if (changes.readonly && this.instance) {
            this.instance.setReadOnly(changes.readonly.currentValue);
        }
    };
    /**
     * On component destroy
     */
    CKEditorComponent.prototype.ngOnDestroy = function () {
        if (this.instance) {
            this.instance.removeAllListeners();
            CKEDITOR.instances[this.instance.name].destroy();
            this.instance.destroy();
            this.instance = null;
        }
    };
    /**
     * On component view init
     */
    CKEditorComponent.prototype.ngAfterViewInit = function () {
        this.ckeditorInit(this.config || {});
    };
    /**
     * On component view checked
     */
    CKEditorComponent.prototype.ngAfterViewChecked = function () {
        this.ckeditorInit(this.config || {});
    };
    /**
     * Value update process
     */
    CKEditorComponent.prototype.updateValue = function (value) {
        var _this = this;
        this.zone.run(function () {
            _this.value = value;
            _this.onChange(value);
            _this.onTouched();
            _this.change.emit(value);
        });
    };
    /**
     * CKEditor init
     */
    CKEditorComponent.prototype.ckeditorInit = function (config) {
        var _this = this;
        if (typeof CKEDITOR === 'undefined') {
            console.warn('CKEditor 4.x is missing (http://ckeditor.com/)');
        }
        else {
            // Check textarea exists
            if (this.instance || !this.documentContains(this.host.nativeElement)) {
                return;
            }
            if (this.readonly) {
                config.readOnly = this.readonly;
            }
            // CKEditor replace textarea
            this.instance = CKEDITOR.replace(this.host.nativeElement, config);
            // Set initial value
            this.instance.setData(this.value);
            // listen for instanceReady event
            this.instance.on('instanceReady', function (evt) {
                // if value has changed while instance loading
                // update instance with current component value
                if (_this.instance.getData() !== _this.value) {
                    _this.instance.setData(_this.value);
                }
                // send the evt to the EventEmitter
                _this.ready.emit(evt);
            });
            // CKEditor change event
            this.instance.on('change', function (evt) {
                _this.onTouched();
                var value = _this.instance.getData();
                if (_this.value !== value) {
                    // Debounce update
                    if (_this.debounce) {
                        if (_this.debounceTimeout)
                            clearTimeout(_this.debounceTimeout);
                        _this.debounceTimeout = setTimeout(function () {
                            _this.updateValue(value);
                            _this.debounceTimeout = null;
                        }, parseInt(_this.debounce));
                        // Live update
                    }
                    else {
                        _this.updateValue(value);
                    }
                }
                // Original ckeditor event dispatch
                _this.editorChange.emit(evt);
            });
            // CKEditor blur event
            this.instance.on('blur', function (evt) {
                _this.blur.emit(evt);
            });
            // CKEditor focus event
            this.instance.on('focus', function (evt) {
                _this.focus.emit(evt);
            });
            // CKEditor contentDom event
            this.instance.on('contentDom', function (evt) {
                _this.contentDom.emit(evt);
            });
            // CKEditor fileUploadRequest event
            this.instance.on('fileUploadRequest', function (evt) {
                _this.fileUploadRequest.emit(evt);
            });
            // CKEditor fileUploadResponse event
            this.instance.on('fileUploadResponse', function (evt) {
                _this.fileUploadResponse.emit(evt);
            });
            // CKEditor paste event
            this.instance.on('paste', function (evt) {
                _this.paste.emit(evt);
            });
            // CKEditor drop event
            this.instance.on('drop', function (evt) {
                _this.drop.emit(evt);
            });
            // Add Toolbar Groups to Editor. This will also add Buttons within groups.
            this.toolbarGroups.forEach(function (group) {
                group.initialize(_this);
            });
            // Add Toolbar Buttons to Editor.
            this.toolbarButtons.forEach(function (button) {
                button.initialize(_this);
            });
        }
    };
    /**
     * Implements ControlValueAccessor
     */
    CKEditorComponent.prototype.writeValue = function (value) {
        this._value = value;
        if (this.instance)
            this.instance.setData(value);
    };
    CKEditorComponent.prototype.onChange = function (_) { };
    CKEditorComponent.prototype.onTouched = function () { };
    CKEditorComponent.prototype.registerOnChange = function (fn) {
        this.onChange = fn;
    };
    CKEditorComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    CKEditorComponent.prototype.documentContains = function (node) {
        return document.contains ? document.contains(node) : document.body.contains(node);
    };
    var CKEditorComponent_1;
    CKEditorComponent.ctorParameters = function () { return [
        { type: NgZone }
    ]; };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "config", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], CKEditorComponent.prototype, "readonly", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], CKEditorComponent.prototype, "debounce", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "change", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "editorChange", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "ready", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "blur", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "focus", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "contentDom", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "fileUploadRequest", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "fileUploadResponse", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "paste", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "drop", void 0);
    tslib_1.__decorate([
        ViewChild('host', { static: false }),
        tslib_1.__metadata("design:type", Object)
    ], CKEditorComponent.prototype, "host", void 0);
    tslib_1.__decorate([
        ContentChildren(CKButtonDirective),
        tslib_1.__metadata("design:type", QueryList)
    ], CKEditorComponent.prototype, "toolbarButtons", void 0);
    tslib_1.__decorate([
        ContentChildren(CKGroupDirective),
        tslib_1.__metadata("design:type", QueryList)
    ], CKEditorComponent.prototype, "toolbarGroups", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], CKEditorComponent.prototype, "value", null);
    CKEditorComponent = CKEditorComponent_1 = tslib_1.__decorate([ tslib_1.__metadata("design:paramtypes", [NgZone])
    ], CKEditorComponent);
CKEditorComponent.Éµfac = function CKEditorComponent_Factory(t) { return new (t || CKEditorComponent)(Éµngcc0.ÉµÉµdirectiveInject(Éµngcc0.NgZone)); };
CKEditorComponent.Éµcmp = Éµngcc0.ÉµÉµdefineComponent({ type: CKEditorComponent, selectors: [["ckeditor"]], contentQueries: function CKEditorComponent_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        Éµngcc0.ÉµÉµcontentQuery(dirIndex, CKButtonDirective, false);
        Éµngcc0.ÉµÉµcontentQuery(dirIndex, CKGroupDirective, false);
    } if (rf & 2) {
        var _t;
        Éµngcc0.ÉµÉµqueryRefresh(_t = Éµngcc0.ÉµÉµloadQuery()) && (ctx.toolbarButtons = _t);
        Éµngcc0.ÉµÉµqueryRefresh(_t = Éµngcc0.ÉµÉµloadQuery()) && (ctx.toolbarGroups = _t);
    } }, viewQuery: function CKEditorComponent_Query(rf, ctx) { if (rf & 1) {
        Éµngcc0.ÉµÉµviewQuery(_c0, true);
    } if (rf & 2) {
        var _t;
        Éµngcc0.ÉµÉµqueryRefresh(_t = Éµngcc0.ÉµÉµloadQuery()) && (ctx.host = _t.first);
    } }, inputs: { value: "value", config: "config", readonly: "readonly", debounce: "debounce" }, outputs: { change: "change", editorChange: "editorChange", ready: "ready", blur: "blur", focus: "focus", contentDom: "contentDom", fileUploadRequest: "fileUploadRequest", fileUploadResponse: "fileUploadResponse", paste: "paste", drop: "drop" }, features: [Éµngcc0.ÉµÉµProvidersFeature([
            {
                provide: NG_VALUE_ACCESSOR,
                useExisting: forwardRef(function () { return CKEditorComponent_1; }),
                multi: true
            },
        ]), Éµngcc0.ÉµÉµNgOnChangesFeature], decls: 2, vars: 0, consts: [["host", ""]], template: function CKEditorComponent_Template(rf, ctx) { if (rf & 1) {
        Éµngcc0.ÉµÉµelement(0, "textarea", null, 0);
    } }, encapsulation: 2 });
/*@__PURE__*/ (function () { Éµngcc0.ÉµsetClassMetadata(CKEditorComponent, [{
        type: Component,
        args: [{
                selector: 'ckeditor',
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(function () { return CKEditorComponent_1; }),
                        multi: true
                    },
                ],
                template: "\n    <textarea #host></textarea>\n  "
            }]
    }], function () { return [{ type: Éµngcc0.NgZone }]; }, { change: [{
            type: Output
        }], editorChange: [{
            type: Output
        }], ready: [{
            type: Output
        }], blur: [{
            type: Output
        }], focus: [{
            type: Output
        }], contentDom: [{
            type: Output
        }], fileUploadRequest: [{
            type: Output
        }], fileUploadResponse: [{
            type: Output
        }], paste: [{
            type: Output
        }], drop: [{
            type: Output
        }], value: [{
            type: Input
        }], config: [{
            type: Input
        }], readonly: [{
            type: Input
        }], debounce: [{
            type: Input
        }], host: [{
            type: ViewChild,
            args: ['host', { static: false }]
        }], toolbarButtons: [{
            type: ContentChildren,
            args: [CKButtonDirective]
        }], toolbarGroups: [{
            type: ContentChildren,
            args: [CKGroupDirective]
        }] }); })();
    return CKEditorComponent;
}());
export { CKEditorComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2tlZGl0b3IuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyJuZzovbmcyLWNrZWRpdG9yL2NrZWRpdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsVUFBVTtBQUNWLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixTQUFTLEVBQ1QsWUFBWSxFQUNaLE1BQU0sRUFDTixVQUFVLEVBQ1YsU0FBUyxFQUNULGFBQWEsRUFDYixlQUFlLEVBQ2YsYUFBYSxFQUNiLFNBQVMsR0FDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUl2RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7Ozs7QUFjSDtBQUFxRCxJQXlCbkQ7QUFDRjtBQUNFLE9BQUc7QUFDTCxJQUFFLDJCQUFvQixJQUFZO0FBQUksUUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBUTtBQUFDLFFBdkJ2QixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQUN4QyxRQUFZLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQUM5QyxRQUFZLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0FBQ3ZDLFFBQVksU0FBSSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDdEMsUUFBWSxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQUN2QyxRQUFZLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0FBQzVDLFFBQVksc0JBQWlCLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQUNuRCxRQUFZLHVCQUFrQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDcEQsUUFBWSxVQUFLLEdBQUcsSUFBSSxZQUFZ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a0RBRkg7QUFFSCxJQXpDYSxpQkFBaUIsc0RBYjdCLFNBQVMsQ0FBQyxjQUNULFFBQVEsRUFBRSwzQ0FZSiwwQ0E0Qm9CLE1BQU07RUF4Q1osY0FDcEIsU0FBUyx6QkF1QzBCLE9BNUJ4QixpQkFBaUIsQ0FpTjdCO0FBNU5ZLGtCQUNULHNCQUNFLE9BQU8sRUFBRSxpQkFBaUIsc0JBQzFCLFdBQVcsRUFBRSxVQUFVLENBQUMsY0FBTSxPQUFBO01BQWlCLEVBQWpCLENBQWlCLENBQUMsc0JBQ2hELEtBQUssRUFBRSxJQUFJLG1CQUNaLGVBQ0YsY0FDRCxRQUFRLEVBQUUsdUNBRVQsVUFDRixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFtTkY7QUFBQyxJQURELHdCQUFDO0FBQ0EsQ0FEQSxBQWpORCxJQWlOQztBQUNELFNBbE5hLGlCQUFpQjtBQUFJIiwic291cmNlc0NvbnRlbnQiOlsiLy8gSW1wb3J0c1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBWaWV3Q2hpbGQsXG4gIEV2ZW50RW1pdHRlcixcbiAgTmdab25lLFxuICBmb3J3YXJkUmVmLFxuICBRdWVyeUxpc3QsXG4gIEFmdGVyVmlld0luaXQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgT25DaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgQ0tCdXR0b25EaXJlY3RpdmUgfSBmcm9tICcuL2NrYnV0dG9uLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBDS0dyb3VwRGlyZWN0aXZlIH0gZnJvbSAnLi9ja2dyb3VwLmRpcmVjdGl2ZSc7XG5cbmRlY2xhcmUgdmFyIENLRURJVE9SOiBhbnk7XG5cbi8qKlxuICogQ0tFZGl0b3IgY29tcG9uZW50XG4gKiBVc2FnZSA6XG4gKiAgPGNrZWRpdG9yIFsobmdNb2RlbCldPVwiZGF0YVwiIFtjb25maWddPVwiey4uLn1cIiBkZWJvdW5jZT1cIjUwMFwiPjwvY2tlZGl0b3I+XG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2NrZWRpdG9yJyxcbiAgcHJvdmlkZXJzOiBbXG4gICAge1xuICAgICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXG4gICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBDS0VkaXRvckNvbXBvbmVudCksXG4gICAgICBtdWx0aTogdHJ1ZSxcbiAgICB9LFxuICBdLFxuICB0ZW1wbGF0ZTogYFxuICAgIDx0ZXh0YXJlYSAjaG9zdD48L3RleHRhcmVhPlxuICBgLFxufSlcbmV4cG9ydCBjbGFzcyBDS0VkaXRvckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgQWZ0ZXJWaWV3SW5pdCB7XG4gIEBJbnB1dCgpIGNvbmZpZzogYW55O1xuICBASW5wdXQoKSByZWFkb25seTogYm9vbGVhbjtcbiAgQElucHV0KCkgZGVib3VuY2U6IHN0cmluZztcblxuICBAT3V0cHV0KCkgY2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgZWRpdG9yQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgcmVhZHkgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBibHVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgZm9jdXMgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBjb250ZW50RG9tID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgZmlsZVVwbG9hZFJlcXVlc3QgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBmaWxlVXBsb2FkUmVzcG9uc2UgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBwYXN0ZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIGRyb3AgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgQFZpZXdDaGlsZCgnaG9zdCcsIHsgc3RhdGljOiBmYWxzZSB9KSBob3N0OiBhbnk7XG5cbiAgQENvbnRlbnRDaGlsZHJlbihDS0J1dHRvbkRpcmVjdGl2ZSkgdG9vbGJhckJ1dHRvbnM6IFF1ZXJ5TGlzdDxDS0J1dHRvbkRpcmVjdGl2ZT47XG4gIEBDb250ZW50Q2hpbGRyZW4oQ0tHcm91cERpcmVjdGl2ZSkgdG9vbGJhckdyb3VwczogUXVlcnlMaXN0PENLR3JvdXBEaXJlY3RpdmU+O1xuXG4gIF92YWx1ZSA9ICcnO1xuICBpbnN0YW5jZTogYW55O1xuICBkZWJvdW5jZVRpbWVvdXQ6IGFueTtcblxuICAvKipcbiAgICogQ29uc3RydWN0b3JcbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgem9uZTogTmdab25lKSB7fVxuXG4gIGdldCB2YWx1ZSgpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZTtcbiAgfVxuICBASW5wdXQoKVxuICBzZXQgdmFsdWUodikge1xuICAgIGlmICh2ICE9PSB0aGlzLl92YWx1ZSkge1xuICAgICAgdGhpcy5fdmFsdWUgPSB2O1xuICAgICAgdGhpcy5vbkNoYW5nZSh2KTtcbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMucmVhZG9ubHkgJiYgdGhpcy5pbnN0YW5jZSkge1xuICAgICAgdGhpcy5pbnN0YW5jZS5zZXRSZWFkT25seShjaGFuZ2VzLnJlYWRvbmx5LmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE9uIGNvbXBvbmVudCBkZXN0cm95XG4gICAqL1xuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5pbnN0YW5jZSkge1xuICAgICAgdGhpcy5pbnN0YW5jZS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgICAgIENLRURJVE9SLmluc3RhbmNlc1t0aGlzLmluc3RhbmNlLm5hbWVdLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuaW5zdGFuY2UuZGVzdHJveSgpO1xuICAgICAgdGhpcy5pbnN0YW5jZSA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE9uIGNvbXBvbmVudCB2aWV3IGluaXRcbiAgICovXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLmNrZWRpdG9ySW5pdCh0aGlzLmNvbmZpZyB8fCB7fSk7XG4gIH1cblxuICAvKipcbiAgICogT24gY29tcG9uZW50IHZpZXcgY2hlY2tlZFxuICAgKi9cbiAgbmdBZnRlclZpZXdDaGVja2VkKCkge1xuICAgIHRoaXMuY2tlZGl0b3JJbml0KHRoaXMuY29uZmlnIHx8IHt9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWx1ZSB1cGRhdGUgcHJvY2Vzc1xuICAgKi9cbiAgdXBkYXRlVmFsdWUodmFsdWU6IGFueSkge1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xuXG4gICAgICB0aGlzLm9uQ2hhbmdlKHZhbHVlKTtcblxuICAgICAgdGhpcy5vblRvdWNoZWQoKTtcbiAgICAgIHRoaXMuY2hhbmdlLmVtaXQodmFsdWUpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENLRWRpdG9yIGluaXRcbiAgICovXG4gIGNrZWRpdG9ySW5pdChjb25maWc6IGFueSkge1xuICAgIGlmICh0eXBlb2YgQ0tFRElUT1IgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0NLRWRpdG9yIDQueCBpcyBtaXNzaW5nIChodHRwOi8vY2tlZGl0b3IuY29tLyknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ2hlY2sgdGV4dGFyZWEgZXhpc3RzXG4gICAgICBpZiAodGhpcy5pbnN0YW5jZSB8fCAhdGhpcy5kb2N1bWVudENvbnRhaW5zKHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50KSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnJlYWRvbmx5KSB7XG4gICAgICAgIGNvbmZpZy5yZWFkT25seSA9IHRoaXMucmVhZG9ubHk7XG4gICAgICB9XG4gICAgICAvLyBDS0VkaXRvciByZXBsYWNlIHRleHRhcmVhXG4gICAgICB0aGlzLmluc3RhbmNlID0gQ0tFRElUT1IucmVwbGFjZSh0aGlzLmhvc3QubmF0aXZlRWxlbWVudCwgY29uZmlnKTtcblxuICAgICAgLy8gU2V0IGluaXRpYWwgdmFsdWVcbiAgICAgIHRoaXMuaW5zdGFuY2Uuc2V0RGF0YSh0aGlzLnZhbHVlKTtcblxuICAgICAgLy8gbGlzdGVuIGZvciBpbnN0YW5jZVJlYWR5IGV2ZW50XG4gICAgICB0aGlzLmluc3RhbmNlLm9uKCdpbnN0YW5jZVJlYWR5JywgKGV2dDogYW55KSA9PiB7XG4gICAgICAgIC8vIGlmIHZhbHVlIGhhcyBjaGFuZ2VkIHdoaWxlIGluc3RhbmNlIGxvYWRpbmdcbiAgICAgICAgLy8gdXBkYXRlIGluc3RhbmNlIHdpdGggY3VycmVudCBjb21wb25lbnQgdmFsdWVcbiAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UuZ2V0RGF0YSgpICE9PSB0aGlzLnZhbHVlKSB7XG4gICAgICAgICAgdGhpcy5pbnN0YW5jZS5zZXREYXRhKHRoaXMudmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gc2VuZCB0aGUgZXZ0IHRvIHRoZSBFdmVudEVtaXR0ZXJcbiAgICAgICAgdGhpcy5yZWFkeS5lbWl0KGV2dCk7XG4gICAgICB9KTtcblxuICAgICAgLy8gQ0tFZGl0b3IgY2hhbmdlIGV2ZW50XG4gICAgICB0aGlzLmluc3RhbmNlLm9uKCdjaGFuZ2UnLCAoZXZ0OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5vblRvdWNoZWQoKTtcbiAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5pbnN0YW5jZS5nZXREYXRhKCk7XG5cbiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7XG4gICAgICAgICAgLy8gRGVib3VuY2UgdXBkYXRlXG4gICAgICAgICAgaWYgKHRoaXMuZGVib3VuY2UpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmRlYm91bmNlVGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZGVib3VuY2VUaW1lb3V0KTtcbiAgICAgICAgICAgIHRoaXMuZGVib3VuY2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMudXBkYXRlVmFsdWUodmFsdWUpO1xuICAgICAgICAgICAgICB0aGlzLmRlYm91bmNlVGltZW91dCA9IG51bGw7XG4gICAgICAgICAgICB9LCBwYXJzZUludCh0aGlzLmRlYm91bmNlKSk7XG5cbiAgICAgICAgICAgIC8vIExpdmUgdXBkYXRlXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlVmFsdWUodmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE9yaWdpbmFsIGNrZWRpdG9yIGV2ZW50IGRpc3BhdGNoXG4gICAgICAgIHRoaXMuZWRpdG9yQ2hhbmdlLmVtaXQoZXZ0KTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDS0VkaXRvciBibHVyIGV2ZW50XG4gICAgICB0aGlzLmluc3RhbmNlLm9uKCdibHVyJywgKGV2dDogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuYmx1ci5lbWl0KGV2dCk7XG4gICAgICB9KTtcblxuICAgICAgLy8gQ0tFZGl0b3IgZm9jdXMgZXZlbnRcbiAgICAgIHRoaXMuaW5zdGFuY2Uub24oJ2ZvY3VzJywgKGV2dDogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuZm9jdXMuZW1pdChldnQpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIENLRWRpdG9yIGNvbnRlbnREb20gZXZlbnRcbiAgICAgIHRoaXMuaW5zdGFuY2Uub24oJ2NvbnRlbnREb20nLCAoZXZ0OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5jb250ZW50RG9tLmVtaXQoZXZ0KTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDS0VkaXRvciBmaWxlVXBsb2FkUmVxdWVzdCBldmVudFxuICAgICAgdGhpcy5pbnN0YW5jZS5vbignZmlsZVVwbG9hZFJlcXVlc3QnLCAoZXZ0OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5maWxlVXBsb2FkUmVxdWVzdC5lbWl0KGV2dCk7XG4gICAgICB9KTtcblxuICAgICAgLy8gQ0tFZGl0b3IgZmlsZVVwbG9hZFJlc3BvbnNlIGV2ZW50XG4gICAgICB0aGlzLmluc3RhbmNlLm9uKCdmaWxlVXBsb2FkUmVzcG9uc2UnLCAoZXZ0OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5maWxlVXBsb2FkUmVzcG9uc2UuZW1pdChldnQpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIENLRWRpdG9yIHBhc3RlIGV2ZW50XG4gICAgICB0aGlzLmluc3RhbmNlLm9uKCdwYXN0ZScsIChldnQ6IGFueSkgPT4ge1xuICAgICAgICB0aGlzLnBhc3RlLmVtaXQoZXZ0KTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDS0VkaXRvciBkcm9wIGV2ZW50XG4gICAgICB0aGlzLmluc3RhbmNlLm9uKCdkcm9wJywgKGV2dDogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuZHJvcC5lbWl0KGV2dCk7XG4gICAgICB9KTtcblxuICAgICAgLy8gQWRkIFRvb2xiYXIgR3JvdXBzIHRvIEVkaXRvci4gVGhpcyB3aWxsIGFsc28gYWRkIEJ1dHRvbnMgd2l0aGluIGdyb3Vwcy5cbiAgICAgIHRoaXMudG9vbGJhckdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHtcbiAgICAgICAgZ3JvdXAuaW5pdGlhbGl6ZSh0aGlzKTtcbiAgICAgIH0pO1xuICAgICAgLy8gQWRkIFRvb2xiYXIgQnV0dG9ucyB0byBFZGl0b3IuXG4gICAgICB0aGlzLnRvb2xiYXJCdXR0b25zLmZvckVhY2goYnV0dG9uID0+IHtcbiAgICAgICAgYnV0dG9uLmluaXRpYWxpemUodGhpcyk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW1wbGVtZW50cyBDb250cm9sVmFsdWVBY2Nlc3NvclxuICAgKi9cbiAgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KSB7XG4gICAgdGhpcy5fdmFsdWUgPSB2YWx1ZTtcbiAgICBpZiAodGhpcy5pbnN0YW5jZSkgdGhpcy5pbnN0YW5jZS5zZXREYXRhKHZhbHVlKTtcbiAgfVxuICBvbkNoYW5nZShfOiBhbnkpIHt9XG4gIG9uVG91Y2hlZCgpIHt9XG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSkge1xuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcbiAgfVxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogYW55KSB7XG4gICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcbiAgfVxuXG4gIHByaXZhdGUgZG9jdW1lbnRDb250YWlucyhub2RlOiBOb2RlKSB7XG4gICAgcmV0dXJuIGRvY3VtZW50LmNvbnRhaW5zID8gZG9jdW1lbnQuY29udGFpbnMobm9kZSkgOiBkb2N1bWVudC5ib2R5LmNvbnRhaW5zKG5vZGUpO1xuICB9XG59XG4iXX0=