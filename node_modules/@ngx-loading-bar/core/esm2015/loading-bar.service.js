/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { PLATFORM_ID, Inject } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import * as i0 from "@angular/core";
import * as ɵngcc0 from '@angular/core';
export class LoadingBarService {
    /**
     * @param {?} platformId
     */
    constructor(platformId) {
        this.platformId = platformId;
        this.progress$ = (/** @type {?} */ ((new Subject()).pipe(debounceTime(0))));
        this._pendingRequests = 0;
        this._value = 0;
    }
    /**
     * @param {?=} initialValue
     * @return {?}
     */
    start(initialValue = 2) {
        ++this._pendingRequests;
        if (this._value === 0 || this._pendingRequests === 1) {
            // Inserts the loading bar element into the dom, and sets it to 2%
            this.set(this._pendingRequests === 1 && this._value > 0 ? this._value : initialValue);
        }
    }
    /**
     * @return {?}
     */
    stop() {
        this.complete();
        while (this._pendingRequests > 0) {
            this.complete();
        }
    }
    /**
     * @return {?}
     */
    complete() {
        if (this._pendingRequests === 0 && this._value === 0) {
            return;
        }
        if (this._pendingRequests > 0) {
            --this._pendingRequests;
        }
        if (this._pendingRequests === 0 || (this._pendingRequests === 0 && this._value > 0)) {
            if (this._value !== 100) {
                this.set(100);
            }
            // Attempt to aggregate any start/complete calls within 500ms:
            setTimeout(() => this.set(0), 500);
        }
    }
    /**
     * Set the loading bar's width to a certain percent.
     *
     * @param {?} n any value between 0 and 100
     * @return {?}
     */
    set(n) {
        if (!isPlatformBrowser(this.platformId)) {
            this._pendingRequests = 0;
            return;
        }
        if (n === 0 && this._pendingRequests > 0) {
            n = 2;
        }
        this._value = n;
        this.progress$.next(n);
        if (this._pendingRequests === 0) {
            return;
        }
        // increment loadingbar to give the illusion that there is always
        // progress but make sure to cancel the previous timeouts so we don't
        // have multiple incs running at the same time.
        clearTimeout(this._incTimeout);
        if (this._value > 0 && this._value < 100) {
            this._incTimeout = setTimeout(() => this.increment(), 250);
        }
    }
    /**
     * Increments the loading bar by a random amount
     * but slows down as it progresses
     * @param {?=} rnd
     * @return {?}
     */
    increment(rnd = 0) {
        if (rnd > 0) {
            this.set(this._value + rnd);
        }
        /** @type {?} */
        const stat = this._value;
        if (stat >= 0 && stat < 25) {
            // Start out between 3 - 6% increments
            rnd = (Math.random() * (5 - 3 + 1) + 3);
        }
        else if (stat >= 25 && stat < 65) {
            // increment between 0 - 3%
            rnd = (Math.random() * 3);
        }
        else if (stat >= 65 && stat < 90) {
            // increment between 0 - 2%
            rnd = (Math.random() * 2);
        }
        else if (stat >= 90 && stat < 99) {
            // finally, increment it .5 %
            rnd = 0.5;
        }
        else {
            // after 99%, don't increment:
            rnd = 0;
        }
        this.set(this._value + rnd);
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.progress$.complete();
    }
}
LoadingBarService.ɵfac = function LoadingBarService_Factory(t) { return new (t || LoadingBarService)(ɵngcc0.ɵɵinject(PLATFORM_ID)); };
LoadingBarService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: LoadingBarService, factory: LoadingBarService.ɵfac, providedIn: 'root' });
/** @nocollapse */
LoadingBarService.ctorParameters = () => [
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
/** @nocollapse */ LoadingBarService.ngInjectableDef = i0.defineInjectable({ factory: function LoadingBarService_Factory() { return new LoadingBarService(i0.inject(i0.PLATFORM_ID)); }, token: LoadingBarService, providedIn: "root" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(LoadingBarService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }]; }, null); })();
if (false) {
    /** @type {?} */
    LoadingBarService.prototype.progress$;
    /**
     * @type {?}
     * @private
     */
    LoadingBarService.prototype._pendingRequests;
    /**
     * @type {?}
     * @private
     */
    LoadingBarService.prototype._value;
    /**
     * @type {?}
     * @private
     */
    LoadingBarService.prototype._incTimeout;
    /**
     * @type {?}
     * @private
     */
    LoadingBarService.prototype.platformId;
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy1iYXIuc2VydmljZS5qcyIsInNvdXJjZXMiOlsibmc6L0BuZ3gtbG9hZGluZy1iYXIvY29yZS9sb2FkaW5nLWJhci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BEOztBQUVBLE1BQU0sT0FBTyxpQkFBaUI7QUFBRztBQUFRO0FBQ3pCO0FBQVEsSUFNdEIsWUFBeUMsVUFBa0I7QUFBSSxRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFRO0FBQUMsUUFObkQsY0FBUyxHQUFHLG1CQUFBLENBQUMsSUFBSSxPQUFPLEVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBbUIsQ0FBQztBQUN4RixRQUNVLHFCQUFnQixHQUFHLENBQUMsQ0FBQztBQUMvQixRQUFVLFdBQU0sR0FBRyxDQUFDLENBQUM7QUFDckIsSUFFZ0UsQ0FBQztBQUNqRTtBQUNPO0FBQ0k7QUFDVjtBQUFRLElBRlAsS0FBSyxDQUFDLFlBQVksR0FBRyxDQUFDO0FBQ3hCLFFBQUksRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUM7QUFDNUIsUUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLEVBQUU7QUFDMUQsWUFBTSxrRUFBa0U7QUFDeEUsWUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFD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QUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTt1SUFDN0I7QUFBQztBQUFtQjtBQUNYLFlBTXlDLE1BQU0sdUJBQTlDLE1BQU0sU0FBQyxXQUFXO0FBQVE7QUFBRzs7Ozs7OztrQ0FNeEI7QUFBQztBQUFhO0FBQXFCLElBWnJELHNDQUFzRjtBQUN4RjtBQUNPO0FBQWlCO0FBQ2hCO0FBQVEsSUFEZCw2Q0FBNkI7QUFDL0I7QUFBUTtBQUNMO0FBQWdCO0FBQVEsSUFEekIsbUNBQW1CO0FBQ3JCO0FBQVE7QUFBaUI7QUFFYjtBQUFRLElBRmxCLHdDQUF5QjtBQUMzQjtBQUNPO0FBQWlCO0FBQWdCO0FBQVEsSUFBbEMsdUNBQStDO0FBQUM7QUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUExBVEZPUk1fSUQsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIExvYWRpbmdCYXJTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcmVhZG9ubHkgcHJvZ3Jlc3MkID0gKG5ldyBTdWJqZWN0PG51bWJlcj4oKSkucGlwZShkZWJvdW5jZVRpbWUoMCkpIGFzIFN1YmplY3Q8bnVtYmVyPjtcblxuICBwcml2YXRlIF9wZW5kaW5nUmVxdWVzdHMgPSAwO1xuICBwcml2YXRlIF92YWx1ZSA9IDA7XG4gIHByaXZhdGUgX2luY1RpbWVvdXQ6IGFueTtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IE9iamVjdCkge31cblxuICBzdGFydChpbml0aWFsVmFsdWUgPSAyKSB7XG4gICAgKyt0aGlzLl9wZW5kaW5nUmVxdWVzdHM7XG4gICAgaWYgKHRoaXMuX3ZhbHVlID09PSAwIHx8IHRoaXMuX3BlbmRpbmdSZXF1ZXN0cyA9PT0gMSkge1xuICAgICAgLy8gSW5zZXJ0cyB0aGUgbG9hZGluZyBiYXIgZWxlbWVudCBpbnRvIHRoZSBkb20sIGFuZCBzZXRzIGl0IHRvIDIlXG4gICAgICB0aGlzLnNldCh0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPT09IDEgJiYgdGhpcy5fdmFsdWUgPiAwID8gdGhpcy5fdmFsdWUgOiBpbml0aWFsVmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHN0b3AoKSB7XG4gICAgdGhpcy5jb21wbGV0ZSgpO1xuICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPiAwKSB7XG4gICAgICB0aGlzLmNvbXBsZXRlKCk7XG4gICAgfVxuICB9XG5cbiAgY29tcGxldGUoKSB7XG4gICAgaWYgKHRoaXMuX3BlbmRpbmdSZXF1ZXN0cyA9PT0gMCAmJiB0aGlzLl92YWx1ZSA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPiAwKSB7XG4gICAgICAtLXRoaXMuX3BlbmRpbmdSZXF1ZXN0cztcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fcGVuZGluZ1JlcXVlc3RzID09PSAwIHx8ICh0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPT09IDAgJiYgdGhpcy5fdmFsdWUgPiAwKSkge1xuICAgICAgaWYgKHRoaXMuX3ZhbHVlICE9PSAxMDApIHtcbiAgICAgICAgdGhpcy5zZXQoMTAwKTtcbiAgICAgIH1cblxuICAgICAgLy8gQXR0ZW1wdCB0byBhZ2dyZWdhdGUgYW55IHN0YXJ0L2NvbXBsZXRlIGNhbGxzIHdpdGhpbiA1MDBtczpcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5zZXQoMCksIDUwMCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgbG9hZGluZyBiYXIncyB3aWR0aCB0byBhIGNlcnRhaW4gcGVyY2VudC5cbiAgICpcbiAgICogQHBhcmFtIG4gYW55IHZhbHVlIGJldHdlZW4gMCBhbmQgMTAwXG4gICAqL1xuICBzZXQobikge1xuICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzID0gMDtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAobiA9PT0gMCAmJiB0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPiAwKSB7XG4gICAgICBuID0gMjtcbiAgICB9XG5cbiAgICB0aGlzLl92YWx1ZSA9IG47XG4gICAgdGhpcy5wcm9ncmVzcyQubmV4dChuKTtcblxuICAgIGlmICh0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBpbmNyZW1lbnQgbG9hZGluZ2JhciB0byBnaXZlIHRoZSBpbGx1c2lvbiB0aGF0IHRoZXJlIGlzIGFsd2F5c1xuICAgIC8vIHByb2dyZXNzIGJ1dCBtYWtlIHN1cmUgdG8gY2FuY2VsIHRoZSBwcmV2aW91cyB0aW1lb3V0cyBzbyB3ZSBkb24ndFxuICAgIC8vIGhhdmUgbXVsdGlwbGUgaW5jcyBydW5uaW5nIGF0IHRoZSBzYW1lIHRpbWUuXG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuX2luY1RpbWVvdXQpO1xuICAgIGlmICh0aGlzLl92YWx1ZSA+IDAgJiYgdGhpcy5fdmFsdWUgPCAxMDApIHtcbiAgICAgIHRoaXMuX2luY1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHRoaXMuaW5jcmVtZW50KCksIDI1MCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEluY3JlbWVudHMgdGhlIGxvYWRpbmcgYmFyIGJ5IGEgcmFuZG9tIGFtb3VudFxuICAgKiBidXQgc2xvd3MgZG93biBhcyBpdCBwcm9ncmVzc2VzXG4gICAqL1xuICBpbmNyZW1lbnQocm5kID0gMCkge1xuICAgIGlmIChybmQgPiAwKSB7XG4gICAgICB0aGlzLnNldCh0aGlzLl92YWx1ZSArIHJuZCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdCA9IHRoaXMuX3ZhbHVlO1xuICAgIGlmIChzdGF0ID49IDAgJiYgc3RhdCA8IDI1KSB7XG4gICAgICAvLyBTdGFydCBvdXQgYmV0d2VlbiAzIC0gNiUgaW5jcmVtZW50c1xuICAgICAgcm5kID0gKE1hdGgucmFuZG9tKCkgKiAoNSAtIDMgKyAxKSArIDMpO1xuICAgIH0gZWxzZSBpZiAoc3RhdCA+PSAyNSAmJiBzdGF0IDwgNjUpIHtcbiAgICAgIC8vIGluY3JlbWVudCBiZXR3ZWVuIDAgLSAzJVxuICAgICAgcm5kID0gKE1hdGgucmFuZG9tKCkgKiAzKTtcbiAgICB9IGVsc2UgaWYgKHN0YXQgPj0gNjUgJiYgc3RhdCA8IDkwKSB7XG4gICAgICAvLyBpbmNyZW1lbnQgYmV0d2VlbiAwIC0gMiVcbiAgICAgIHJuZCA9IChNYXRoLnJhbmRvbSgpICogMik7XG4gICAgfSBlbHNlIGlmIChzdGF0ID49IDkwICYmIHN0YXQgPCA5OSkge1xuICAgICAgLy8gZmluYWxseSwgaW5jcmVtZW50IGl0IC41ICVcbiAgICAgIHJuZCA9IDAuNTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYWZ0ZXIgOTklLCBkb24ndCBpbmNyZW1lbnQ6XG4gICAgICBybmQgPSAwO1xuICAgIH1cblxuICAgIHRoaXMuc2V0KHRoaXMuX3ZhbHVlICsgcm5kKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMucHJvZ3Jlc3MkLmNvbXBsZXRlKCk7XG4gIH1cbn1cbiJdfQ==